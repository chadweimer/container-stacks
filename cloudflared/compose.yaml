services:
  cloudflared:
    command:
      - tunnel
      - '--no-autoupdate'
      - '--metrics'
      - 0.0.0.0:60123
      - run
    container_name: cloudflared
    environment:
      TUNNEL_TOKEN: ${TUNNEL_TOKEN}
    healthcheck:
      interval: 10s
      retries: 5
      start_period: 10s
      test:
        - 'CMD'
        - 'cloudflared'
        - 'tunnel'
        - '--metrics'
        - '127.0.0.1:60123'
        - 'ready'
      timeout: 30s
    image: cloudflare/cloudflared:${IMAGE_TAG:-latest}
    labels:
      homepage.group: Network
      homepage.href: https://one.dash.cloudflare.com
      homepage.icon: cloudflare.png
      homepage.name: Cloudflare Tunnel
      homepage.widget.accountid: ${ACCOUNT_ID}
      homepage.widget.key: ${API_TOKEN}
      homepage.widget.tunnelid: ${TUNNEL_ID}
      homepage.widget.type: cloudflared
      prometheus.label.instance: truenas-server
      prometheus.port: 60123
    network_mode: host
    pull_policy: always
    restart: unless-stopped
    user: '568:568'
